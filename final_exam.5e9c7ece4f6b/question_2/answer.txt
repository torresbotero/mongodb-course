db.messages.aggregate([{"$unwind":"$headers.To"},{"$project":{"sender":"$headers.From","recipient":"$headers.To"}},{"$group":{"_id":{"ident":"$_id","sender":"$sender","recipient":"$recipient"},"count_pairs":{"$sum":1}}},{"$group":{"_id":{"sender":"$_id.sender","recipient":"$_id.recipient"},"real_count":{"$sum":1}}},{"$sort":{"real_count":-1}}],{allowDiskUse:true})